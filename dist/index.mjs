#!/usr/bin/env node
import{program as u}from"commander";import{isFuture as f,isValid as g,parse as y}from"date-fns";import m from"inquirer";import{v4 as q}from"uuid";import{eq as p}from"drizzle-orm";import I from"better-sqlite3";import"dotenv/config";import{drizzle as N}from"drizzle-orm/better-sqlite3";import{migrate as z}from"drizzle-orm/better-sqlite3/migrator";var E=new I(process.env.DB_FILE_NAME||"db.sqlite"),d=N(E);z(d,{migrationsFolder:"./drizzle"});import{integer as L,real as M,sqliteTable as O,text as c}from"drizzle-orm/sqlite-core";var l=O("filmes",{id:c("id").primaryKey(),titulo:c("titulo").notNull(),diretor:c("diretor").notNull(),anoLancamento:L("ano_lancamento").notNull(),genero:c("genero"),nota:M("nota"),dataAssistido:c("data_assistido")});var i=class{static async findAll(){return await d.select().from(l)}static async findById(e){return(await d.select().from(l).where(p(l.id,e)).limit(1))[0]??null}static async create(e){await d.insert(l).values(e)}static async update(e,o){let a=await d.update(l).set(o).where(p(l.id,e)).returning();if(a.length===0)throw new Error("Filme not found");return a[0]}static async delete(e){if((await d.delete(l).where(p(l.id,e)).returning()).length===0)throw new Error("Filme not found")}};async function A(){try{let t=await i.findAll();if(t.length===0){console.log(`
\u{1F3AC} Nenhum filme cadastrado.`);return}console.log(`
\u{1F3AC} Lista de Filmes:`),console.table(t)}catch(t){console.error(`
\u274C Erro ao listar filmes:`,t.message)}}async function w(t){let e=t;if(e||(e=(await m.prompt([{type:"input",name:"id",message:"Digite o ID (UUID) do filme:",validate:a=>a?!0:"O ID \xE9 obrigat\xF3rio."}])).id),e)try{let o=await i.findById(e);o?(console.log(`
\u{1F50E} Filme encontrado:`),console.table([o])):console.error(`
\u274C Filme n\xE3o encontrado.`)}catch(o){console.error(`
\u274C Erro ao buscar filme:`,o.message)}}async function v(){try{console.log(`
\u2795 Cadastrando um novo filme...`);let t=[{type:"input",name:"titulo",message:"T\xEDtulo:",validate:a=>a?!0:"Obrigat\xF3rio."},{type:"input",name:"diretor",message:"Diretor(a):",validate:a=>a?!0:"Obrigat\xF3rio."},{type:"input",name:"anoLancamento",message:"Ano de Lan\xE7amento:",validate:a=>{let n=parseInt(a),r=new Date().getFullYear();return isNaN(n)||a.length!==4?"Ano inv\xE1lido (deve ter 4 d\xEDgitos).":n>r?"O ano de lan\xE7amento n\xE3o pode ser no futuro.":!0}},{type:"input",name:"genero",message:"G\xEAnero (opcional):"},{type:"input",name:"nota",message:"Nota (0-10, opcional):",validate:a=>{if(a==="")return!0;let n=parseFloat(a);return!isNaN(n)&&n>=0&&n<=10?!0:"Nota inv\xE1lida. Deve ser entre 0 e 10."}},{type:"input",name:"dataAssistido",message:"Data Assistido (DD/MM/AAAA, opcional):",validate:a=>{if(a==="")return!0;let n=y(a,"dd/MM/yyyy",new Date);return g(n)?f(n)?"A data n\xE3o pode ser no futuro.":!0:"Formato inv\xE1lido. Use DD/MM/AAAA"}}],e=await m.prompt(t),o={id:q(),titulo:e.titulo,diretor:e.diretor,anoLancamento:parseInt(e.anoLancamento),genero:e.genero||null,nota:e.nota?parseFloat(e.nota):null,dataAssistido:e.dataAssistido||null};await i.create(o),console.log(`
\u2705 Filme cadastrado com sucesso!`)}catch(t){console.error(`
\u274C Erro ao cadastrar o filme:`,t.message)}}async function D(){try{let{id:t}=await m.prompt([{type:"input",name:"id",message:"Digite o ID do filme para atualizar:",validate:r=>r?!0:"O ID \xE9 obrigat\xF3rio."}]),e=await i.findById(t);if(!e){console.error(`
\u274C Filme n\xE3o encontrado.`);return}console.log(`
\u{1F504} Atualizando filme (pressione Enter para manter o valor atual):`);let o=[{type:"input",name:"titulo",message:`T\xEDtulo [${e.titulo}]:`,default:e.titulo},{type:"input",name:"diretor",message:`Diretor(a) [${e.diretor}]:`,default:e.diretor},{type:"input",name:"anoLancamento",message:`Ano [${e.anoLancamento}]:`,default:String(e.anoLancamento),validate:r=>{if(r==="")return!0;let s=parseInt(r),b=new Date().getFullYear();return isNaN(s)||r.length!==4?"Ano inv\xE1lido.":s>b?"O ano de lan\xE7amento n\xE3o pode ser no futuro.":!0}},{type:"input",name:"genero",message:`G\xEAnero [${e.genero||"N/A"}]:`,default:e.genero??""},{type:"input",name:"nota",message:`Nota [${e.nota||"N/A"}]:`,default:e.nota?String(e.nota):"",validate:r=>{if(r==="")return!0;let s=parseFloat(r);return!isNaN(s)&&s>=0&&s<=10?!0:"Nota deve ser entre 0 e 10."}},{type:"input",name:"dataAssistido",message:`Data Assistido [${e.dataAssistido||"N/A"}]:`,default:e.dataAssistido??"",validate:r=>{if(r==="")return!0;let s=y(r,"dd/MM/yyyy",new Date);return g(s)?f(s)?"A data n\xE3o pode ser no futuro.":!0:"Formato inv\xE1lido. Use DD/MM/AAAA"}}],a=await m.prompt(o),n={titulo:a.titulo,diretor:a.diretor,anoLancamento:parseInt(a.anoLancamento),genero:a.genero||null,nota:a.nota?parseFloat(a.nota):null,dataAssistido:a.dataAssistido||null};await i.update(t,n),console.log(`
\u2705 Filme atualizado com sucesso!`)}catch(t){console.error(`
\u274C Erro ao atualizar filme:`,t.message)}}async function F(){try{let{id:t}=await m.prompt([{type:"input",name:"id",message:"Digite o ID do filme para deletar:",validate:a=>a?!0:"O ID \xE9 obrigat\xF3rio."}]),e=await i.findById(t);if(!e){console.error(`
\u274C Filme n\xE3o encontrado.`);return}let{confirmar:o}=await m.prompt([{type:"confirm",name:"confirmar",message:`Tem certeza que deseja deletar "${e.titulo}"?`,default:!1}]);o?(await i.delete(t),console.log(`
\u{1F5D1}\uFE0F Filme deletado com sucesso!`)):console.log(`
Opera\xE7\xE3o cancelada.`)}catch(t){console.error(`
\u274C Erro ao deletar filme:`,t.message)}}async function h(){let t=[{type:"list",name:"action",message:"O que deseja fazer?",choices:[{name:"\u{1F4CB} Listar todos os filmes",value:"listar"},{name:"\u2795 Cadastrar um novo filme",value:"cadastrar"},{name:"\u{1F50D} Buscar um filme por ID",value:"buscar"},{name:"\u{1F504} Atualizar um filme",value:"atualizar"},{name:"\u{1F5D1}\uFE0F Deletar um filme",value:"deletar"},new m.Separator,{name:"\u274C Sair",value:"sair"}]}],{action:e}=await m.prompt(t);switch(e){case"listar":await A();break;case"cadastrar":await v();break;case"buscar":await w();break;case"atualizar":await D();break;case"deletar":await F();break;case"sair":console.log(`
\u{1F44B} At\xE9 logo!`),process.exit(0)}let{again:o}=await m.prompt([{type:"confirm",name:"again",message:`
Deseja realizar outra opera\xE7\xE3o?`,default:!0}]);o?await h():console.log(`
\u{1F44B} At\xE9 logo!`)}u.version("1.0.0").description("Gerenciador de Filmes via CLI");u.command("listar").description("Lista todos os filmes").action(A);u.command("cadastrar").description("Cadastra um novo filme").action(v);u.command("buscar [id]").description("Busca um filme pelo ID (opcional)").action(w);u.command("atualizar").description("Atualiza os dados de um filme").action(D);u.command("deletar").description("Deleta um filme").action(F);process.argv.length<=2?h():u.parse(process.argv);
