#!/usr/bin/env node
import{program as m}from"commander";import{isValid as p,parse as f}from"date-fns";import n from"inquirer";import{v4 as M}from"uuid";import{eq as u}from"drizzle-orm";import h from"better-sqlite3";import"dotenv/config";import{drizzle as I}from"drizzle-orm/better-sqlite3";import{migrate as b}from"drizzle-orm/better-sqlite3/migrator";var z=new h(process.env.DB_FILE_NAME),l=I(z);b(l,{migrationsFolder:"./drizzle"});import{integer as E,real as L,sqliteTable as N,text as d}from"drizzle-orm/sqlite-core";var i=N("filmes",{id:d("id").primaryKey(),titulo:d("titulo").notNull(),diretor:d("diretor").notNull(),anoLancamento:E("ano_lancamento").notNull(),genero:d("genero"),nota:L("nota"),dataAssistido:d("data_assistido")});var r=class{static async findAll(){return await l.select().from(i)}static async findById(e){return(await l.select().from(i).where(u(i.id,e)).limit(1))[0]??null}static async create(e){await l.insert(i).values(e)}static async update(e,o){let a=await l.update(i).set(o).where(u(i.id,e)).returning();if(a.length===0)throw new Error("Filme not found");return a[0]}static async delete(e){if((await l.delete(i).where(u(i.id,e)).returning()).length===0)throw new Error("Filme not found")}};async function g(){try{let t=await r.findAll();if(t.length===0){console.log(`
\u{1F3AC} Nenhum filme cadastrado.`);return}console.log(`
\u{1F3AC} Lista de Filmes:`),console.table(t)}catch(t){console.error(`
\u274C Erro ao listar filmes:`,t.message)}}async function y(t){let e=t;if(e||(e=(await n.prompt([{type:"input",name:"id",message:"Digite o ID (UUID) do filme:",validate:a=>a?!0:"O ID \xE9 obrigat\xF3rio."}])).id),e)try{let o=await r.findById(e);o?(console.log(`
\u{1F50E} Filme encontrado:`),console.table([o])):console.error(`
\u274C Filme n\xE3o encontrado.`)}catch(o){console.error(`
\u274C Erro ao buscar filme:`,o.message)}}async function w(){try{console.log(`
\u2795 Cadastrando um novo filme...`);let t=[{type:"input",name:"titulo",message:"T\xEDtulo:",validate:a=>a?!0:"Obrigat\xF3rio."},{type:"input",name:"diretor",message:"Diretor(a):",validate:a=>a?!0:"Obrigat\xF3rio."},{type:"input",name:"anoLancamento",message:"Ano de Lan\xE7amento:",validate:a=>!isNaN(parseInt(a))&&a.length===4?!0:"Ano inv\xE1lido."},{type:"input",name:"genero",message:"G\xEAnero (opcional):"},{type:"input",name:"nota",message:"Nota (0-10, opcional):"},{type:"input",name:"dataAssistido",message:"Data Assistido (DD/MM/AAAA, opcional):",validate:a=>{if(!a)return!0;let c=f(a,"dd/MM/yyyy",new Date);return p(c)?!0:"Formato inv\xE1lido. Use DD/MM/AAAA"}}],e=await n.prompt(t),o={id:M(),titulo:e.titulo,diretor:e.diretor,anoLancamento:parseInt(e.anoLancamento),genero:e.genero||null,nota:e.nota?parseFloat(e.nota):null,dataAssistido:e.dataAssistido||null};await r.create(o),console.log(`
\u2705 Filme cadastrado com sucesso!`)}catch(t){console.error(`
\u274C Erro ao cadastrar o filme:`,t.message)}}async function A(){try{let{id:t}=await n.prompt([{type:"input",name:"id",message:"Digite o ID do filme para atualizar:",validate:s=>s?!0:"O ID \xE9 obrigat\xF3rio."}]),e=await r.findById(t);if(!e){console.error(`
\u274C Filme n\xE3o encontrado.`);return}console.log(`
\u{1F504} Atualizando filme (pressione Enter para manter o valor atual):`);let o=[{type:"input",name:"titulo",message:`T\xEDtulo [${e.titulo}]:`,default:e.titulo},{type:"input",name:"diretor",message:`Diretor(a) [${e.diretor}]:`,default:e.diretor},{type:"input",name:"anoLancamento",message:`Ano [${e.anoLancamento}]:`,default:String(e.anoLancamento),validate:s=>s===""||!isNaN(parseInt(s))&&s.length===4?!0:"Inv\xE1lido."},{type:"input",name:"genero",message:`G\xEAnero [${e.genero||"N/A"}]:`,default:e.genero??""},{type:"input",name:"nota",message:`Nota [${e.nota||"N/A"}]:`,default:e.nota?String(e.nota):""},{type:"input",name:"dataAssistido",message:`Data Assistido [${e.dataAssistido||"N/A"}]:`,default:e.dataAssistido??"",validate:s=>{if(!s)return!0;let F=f(s,"dd/MM/yyyy",new Date);return p(F)?!0:"Formato inv\xE1lido. Use DD/MM/AAAA"}}],a=await n.prompt(o),c={titulo:a.titulo,diretor:a.diretor,anoLancamento:parseInt(a.anoLancamento),genero:a.genero||null,nota:a.nota?parseFloat(a.nota):null,dataAssistido:a.dataAssistido||null};await r.update(t,c),console.log(`
\u2705 Filme atualizado com sucesso!`)}catch(t){console.error(`
\u274C Erro ao atualizar filme:`,t.message)}}async function v(){try{let{id:t}=await n.prompt([{type:"input",name:"id",message:"Digite o ID do filme para deletar:",validate:a=>a?!0:"O ID \xE9 obrigat\xF3rio."}]),e=await r.findById(t);if(!e){console.error(`
\u274C Filme n\xE3o encontrado.`);return}let{confirmar:o}=await n.prompt([{type:"confirm",name:"confirmar",message:`Tem certeza que deseja deletar "${e.titulo}"?`,default:!1}]);o?(await r.delete(t),console.log(`
\u{1F5D1}\uFE0F Filme deletado com sucesso!`)):console.log(`
Opera\xE7\xE3o cancelada.`)}catch(t){console.error(`
\u274C Erro ao deletar filme:`,t.message)}}async function D(){let t=[{type:"list",name:"action",message:"O que deseja fazer?",choices:[{name:"\u{1F4CB} Listar todos os filmes",value:"listar"},{name:"\u2795 Cadastrar um novo filme",value:"cadastrar"},{name:"\u{1F50D} Buscar um filme por ID",value:"buscar"},{name:"\u{1F504} Atualizar um filme",value:"atualizar"},{name:"\u{1F5D1}\uFE0F Deletar um filme",value:"deletar"},new n.Separator,{name:"\u274C Sair",value:"sair"}]}],{action:e}=await n.prompt(t);switch(e){case"listar":await g();break;case"cadastrar":await w();break;case"buscar":await y();break;case"atualizar":await A();break;case"deletar":await v();break;case"sair":console.log(`
\u{1F44B} At\xE9 logo!`),process.exit(0)}let{again:o}=await n.prompt([{type:"confirm",name:"again",message:`
Deseja realizar outra opera\xE7\xE3o?`,default:!0}]);o?await D():console.log(`
\u{1F44B} At\xE9 logo!`)}m.version("1.0.0").description("Gerenciador de Filmes via CLI");m.command("listar").description("Lista todos os filmes").action(g);m.command("cadastrar").description("Cadastra um novo filme").action(w);m.command("buscar [id]").description("Busca um filme pelo ID (opcional)").action(y);m.command("atualizar").description("Atualiza os dados de um filme").action(A);m.command("deletar").description("Deleta um filme").action(v);process.argv.length<=2?D():m.parse(process.argv);
